<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Frequ√™ncia de Bolsistas</title>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
.container{background:#fff;padding:20px;border-radius:8px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #ccc;padding:5px;text-align:center}
th{background:#eee}
input,select{width:100%;font-size:12px}
button{padding:6px 10px;border:none;border-radius:4px;cursor:pointer}
.admin{background:#0057b8;color:#fff}
.coord{background:#2e7d32;color:#fff}
.danger{background:#c62828;color:#fff}
.topo{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.acoes{margin-bottom:15px}
</style>
</head>

<body>

<div class="container">

<div class="topo">
  <h3 id="perfil"></h3>
  <button onclick="logout()">Sair</button>
</div>

<div class="acoes">
  <button id="btnNovo" class="admin" style="display:none" onclick="novoBolsista()">
    ‚ûï Adicionar Bolsista
  </button>
</div>

<table>
<thead>
<tr>
<th>Campus</th><th>Nome</th><th>Matr√≠cula</th><th>Setor</th>
<th>In√≠cio</th><th>Fim</th><th>Email Coord.</th>
<th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th>
<th>Mai</th><th>Jun</th><th>Jul</th><th>Ago</th>
<th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>
<th>Justificativa</th>
<th>Arquivo</th>
<th>A√ß√µes</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script>
const URL_APPS = "https://script.google.com/macros/s/AKfycbykZ7NK0tvxBGRsAkDHV80R_oqTHsCYSK0claw_-TEwcf5EUteTYvscBAStdXuKh9_HWQ/exec";
const EMAIL_ADMIN = "bolsatrabalho@prex.uespi.br";

// ================= USU√ÅRIO =================
const params = new URLSearchParams(window.location.search);
const email = (params.get("email") || "").toLowerCase().trim();

if(!email){
  alert("Acesso inv√°lido. Fa√ßa login novamente.");
  location.href="login.html";
}

const tipo = email === EMAIL_ADMIN ? "admin" : "coordenador";
document.getElementById("perfil").innerText =
`Usu√°rio: ${email} | ${tipo.toUpperCase()}`;

if(tipo==="admin"){
  document.getElementById("btnNovo").style.display="inline-block";
}

let bolsistas=[];

// ================= LISTAR =================
fetch(`${URL_APPS}?acao=listar&email=${encodeURIComponent(email)}`)
.then(r=>r.json())
.then(d=>{
  bolsistas=d.dados||[];
  render();
});

// ================= RENDER =================
function render(){
const meses=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
const tb=document.getElementById("tbody");
tb.innerHTML="";

bolsistas.forEach((b,i)=>{
let tr=document.createElement("tr");

function campo(v,edit){
 return `<input value="${v||""}" ${edit?"":"readonly"}>`;
}

tr.innerHTML=`
<td>${campo(b.campus,tipo==="admin")}</td>
<td>${campo(b.nome,tipo==="admin")}</td>
<td>${campo(b.matricula,tipo==="admin")}</td>
<td>${campo(b.setor,tipo==="admin")}</td>
<td>${campo(b.inicio,tipo==="admin")}</td>
<td>${campo(b.fim,tipo==="admin")}</td>
<td>${campo(b.email_coordenador,tipo==="admin")}</td>

${meses.map(m=>`
<td>
<select>
<option value=""></option>
<option ${b[m]=="SIM"?"selected":""}>SIM</option>
<option ${b[m]=="N√ÉO"?"selected":""}>N√ÉO</option>
</select>
</td>`).join("")}

<td><input value="${b.justificativa||""}"></td>

<td>
<input type="file" onchange="upload(event,${i})">
${b.arquivo?`<br><a href="${b.arquivo}" target="_blank">Ver</a>`:""}
</td>

<td>
<button class="${tipo==="admin"?"admin":"coord"}"
onclick="salvar(${i})">üíæ Salvar</button>

${tipo==="admin"?`
<br><br>
<button class="danger" onclick="remover(${i})">üóëÔ∏è Remover</button>
`:""}
</td>
`;

tb.appendChild(tr);
});
}

// ================= SALVAR =================
function salvar(i){
const tr=document.getElementById("tbody").children[i];
const inputs=tr.querySelectorAll("input,select");
const meses=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];

let d={
campus:inputs[0].value,
nome:inputs[1].value,
matricula:inputs[2].value,
setor:inputs[3].value,
inicio:inputs[4].value,
fim:inputs[5].value,
email_coordenador:inputs[6].value,
justificativa:inputs[19].value
};

meses.forEach((m,j)=>d[m]=inputs[7+j].value);
Object.assign(d,bolsistas[i]);

fetch(URL_APPS,{
method:"POST",
body:JSON.stringify(d)
})
.then(r=>r.json())
.then(()=>alert("Dados salvos com sucesso"));
}

// ================= UPLOAD =================
function upload(e,i){
const f=e.target.files[0];
if(!f)return;
const r=new FileReader();
r.onload=()=>{
bolsistas[i].arquivoBase64=r.result.split(",")[1];
bolsistas[i].arquivoNome=f.name;
bolsistas[i].arquivoMime=f.type;
};
r.readAsDataURL(f);
}

// ================= ADMIN =================
function novoBolsista(){
bolsistas.push({});
render();
}

function remover(i){
if(confirm("Deseja remover este bolsista?")){
bolsistas.splice(i,1);
render();
}
}

// ================= LOGOUT =================
function logout(){
location.href="login.html";
}
</script>

</body>
</html>
